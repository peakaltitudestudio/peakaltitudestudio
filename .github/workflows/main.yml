name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v2

    - name: Configure AWS Usage
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}

    - name: Setup Terraform State Backend
      run: |
        # cd terraform/pipeline-tf-create-bucket
        # terraform init
        # terraform apply -auto-approve
        # cd ..
        # aws s3api head-bucket --bucket "tf-state-storage-bucket" --region "us-west-1"
        cd terraform
        mv ./pipeline-tf-backend/backend.tf ./backend.tf

    - name: Run Main Terraform
      env:
        TF_VAR_PREFIX: "ci-"
      run: |
        cd terraform
        terraform init
        terraform apply -auto-approve
        public_ip=$(terraform output -json public_ip | tr -d '"')
        echo "PUBLIC_IP=$public_ip" >> $GITHUB_ENV

    - name: Set up Docker
      run: |
        cd pas-website
        docker build . --tag ghcr.io/peakaltitudestudio/pas-website-ghrc:latest
        docker login -u ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.GHCR_TOKEN }} ghcr.io
        docker push ghcr.io/peakaltitudestudio/pas-website-ghrc:latest

    - name: Print Public IPv4
      run: |
        echo "Public IP Is: ${{ env.PUBLIC_IP }}"

    - name: Deploy to EC2 Instance
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.PUBLIC_IP }}
        username: ec2-user
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        stript_stop: true
        script: |
          set -e
          container_id=$(docker ps -q)
          if [ -n "$container_id" ]; then
            docker kill $container_id
          fi
          echo 
          docker login -u ${{ secrets.DOCKER_USERNAME }} --password ${{ secrets.GHCR_TOKEN }} ghcr.io
          docker pull ghcr.io/peakaltitudestudio/pas-website-ghrc:latest
          docker run -d -p 3000:3000 ghcr.io/peakaltitudestudio/pas-website-ghrc